<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tipper Maintenance Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.21.4/Babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Simulated backend API for email notifications
        const sendNotification = async (equipmentName, currentHmr, nextDueHrs, balance) => {
            try {
                // In a real implementation, this would be an API call to a Node.js backend
                console.log(`Sending notification for ${equipmentName}: Current HMR: ${currentHmr}, Next Due: ${nextDueHrs}, Balance: ${balance}`);
                return true;
            } catch (error) {
                console.error('Failed to send notification:', error);
                return false;
            }
        };

        const calculateStatus = (balance) => {
            if (balance >= 100) return { status: 'OK', emoji: '游릭' };
            if (balance >= 0) return { status: 'Warning', emoji: '游리' };
            return { status: 'Overdue', emoji: '游댮' };
        };

        const TipperCard = ({ tipper }) => {
            return (
                <div className="bg-white p-4 rounded-lg shadow-md mb-4">
                    <h3 className="text-lg font-bold">{tipper.equipment}</h3>
                    <p>Last Service: {moment(tipper.lastServiceDate).format('YYYY-MM-DD')}</p>
                    <p>Last Service HMR: {tipper.lastServiceHmr.toFixed(1)}</p>
                    <p>Next Due Hrs: {tipper.nextDueHrs.toFixed(1)}</p>
                    <p>Current HMR: {tipper.currentHmr.toFixed(1)}</p>
                    <p>Balance: {tipper.balance.toFixed(1)}</p>
                    <p className={`font-semibold ${tipper.status.includes('Overdue') ? 'text-red-600' : tipper.status.includes('Warning') ? 'text-yellow-600' : 'text-green-600'}`}>
                        Status: {tipper.status}
                    </p>
                    <p>Notification Sent: {tipper.notificationSent ? 'Yes' : 'No'}</p>
                </div>
            );
        };

        const AddTipperForm = ({ addTipper }) => {
            const [formData, setFormData] = useState({
                equipment: '',
                lastServiceDate: '',
                lastServiceHmr: 0,
                nextDueHrs: 0,
                currentHmr: 0
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData({ ...formData, [name]: value });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.equipment || !formData.lastServiceDate || !formData.lastServiceHmr || !formData.nextDueHrs || !formData.currentHmr) {
                    alert('Please fill all required fields');
                    return;
                }

                const balance = parseFloat(formData.nextDueHrs) - parseFloat(formData.currentHmr);
                const { status, emoji } = calculateStatus(balance);
                const newTipper = {
                    equipment: formData.equipment,
                    lastServiceDate: new Date(formData.lastServiceDate),
                    lastServiceHmr: parseFloat(formData.lastServiceHmr),
                    nextDueHrs: parseFloat(formData.nextDueHrs),
                    currentHmr: parseFloat(formData.currentHmr),
                    balance,
                    status: `${status} ${emoji}`,
                    notificationSent: false
                };

                if (balance <= 50) {
                    const sent = await sendNotification(formData.equipment, formData.currentHmr, formData.nextDueHrs, balance);
                    if (sent) {
                        newTipper.notificationSent = true;
                        alert('Notification sent to maintenance team!');
                    }
                }

                addTipper(newTipper);
                setFormData({ equipment: '', lastServiceDate: '', lastServiceHmr: 0, nextDueHrs: 0, currentHmr: 0 });
            };

            return (
                <form onSubmit={handleSubmit} className="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h2 className="text-xl font-bold mb-4">Add New Tipper</h2>
                    <div className="grid grid-cols-2 gap-4">
                        <input
                            type="text"
                            name="equipment"
                            value={formData.equipment}
                            onChange={handleChange}
                            placeholder="Tipper Name*"
                            className="border p-2 rounded"
                            required
                        />
                        <input
                            type="date"
                            name="lastServiceDate"
                            value={formData.lastServiceDate}
                            onChange={handleChange}
                            className="border p-2 rounded"
                            required
                        />
                        <input
                            type="number"
                            name="lastServiceHmr"
                            value={formData.lastServiceHmr}
                            onChange={handleChange}
                            placeholder="Last Service HMR*"
                            className="border p-2 rounded"
                            step="0.1"
                            required
                        />
                        <input
                            type="number"
                            name="nextDueHrs"
                            value={formData.nextDueHrs}
                            onChange={handleChange}
                            placeholder="Next Due Hrs*"
                            className="border p-2 rounded"
                            step="0.1"
                            required
                        />
                        <input
                            type="number"
                            name="currentHmr"
                            value={formData.currentHmr}
                            onChange={handleChange}
                            placeholder="Current HMR*"
                            className="border p-2 rounded"
                            step="0.1"
                            required
                        />
                    </div>
                    <button type="submit" className="mt-4 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                        Add Tipper
                    </button>
                </form>
            );
        };

        const Dashboard = () => {
            const [tippers, setTippers] = useState([
                {
                    equipment: 'Tipper 1 - Ashok Leyland',
                    lastServiceDate: new Date('2024-10-15'),
                    lastServiceHmr: 4150.9,
                    nextDueHrs: 4650.9,
                    currentHmr: 4859.0,
                    balance: -208.1,
                    status: 'Overdue 游댮',
                    notificationSent: true
                },
                // Add 8 more tippers with sample data
                {
                    equipment: 'Tipper 2 - Tata',
                    lastServiceDate: new Date('2024-11-01'),
                    lastServiceHmr: 7660.2,
                    nextDueHrs: 8062.0,
                    currentHmr: 8040.2,
                    balance: 21.8,
                    status: 'Warning 游리',
                    notificationSent: false
                },
                {
                    equipment: 'Tipper 3 - Eicher',
                    lastServiceDate: new Date('2024-09-20'),
                    lastServiceHmr: 3200.5,
                    nextDueHrs: 3600.5,
                    currentHmr: 3500.0,
                    balance: 100.5,
                    status: 'OK 游릭',
                    notificationSent: false
                },
                {
                    equipment: 'Tipper 4 - BharatBenz',
                    lastServiceDate: new Date('2024-08-10'),
                    lastServiceHmr: 5000.0,
                    nextDueHrs: 5500.0,
                    currentHmr: 5600.0,
                    balance: -100.0,
                    status: 'Overdue 游댮',
                    notificationSent: true
                },
                {
                    equipment: 'Tipper 5 - Mahindra',
                    lastServiceDate: new Date('2024-07-15'),
                    lastServiceHmr: 2800.0,
                    nextDueHrs: 3300.0,
                    currentHmr: 3250.0,
                    color: 'bg-blue-100',
                    balance: 50.0,
                    status: 'Warning 游리',
                    notificationSent: true
                },
                {
                    equipment: 'Tipper 6 - Volvo',
                    lastServiceDate: new Date('2024-06-01'),
                    lastServiceHmr: 6000.0,
                    nextDueHrs: 6500.0,
                    currentHmr: 6200.0,
                    balance: 300.0,
                    status: 'OK 游릭',
                    notificationSent: false
                },
                {
                    equipment: 'Tipper 7 - Scania',
                    lastServiceDate: new Date('2024-05-20'),
                    lastServiceHmr: 4500.0,
                    nextDueHrs: 5000.0,
                    currentHmr: 5100.0,
                    balance: -100.0,
                    status: 'Overdue 游댮',
                    notificationSent: true
                },
                {
                    equipment: 'Tipper 8 - MAN',
                    lastServiceDate: new Date('2024-04-10'),
                    lastServiceHmr: 3700.0,
                    nextDueHrs: 4200.0,
                    currentHmr: 4000.0,
                    balance: 200.0,
                    status: 'OK 游릭',
                    notificationSent: false
                },
                {
                    equipment: 'Tipper 9 - Kamaz',
                    lastServiceDate: new Date('2024-03-01'),
                    lastServiceHmr: 3900.0,
                    nextDueHrs: 4400.0,
                    currentHmr: 4350.0,
                    balance: 50.0,
                    status: 'Warning 游리',
                    notificationSent: true
                }
            ]);

            const addTipper = (newTipper) => {
                setTippers([...tippers, newTipper]);
            };

            const clearData = () => {
                setTippers([]);
            };

            const exportToCsv = () => {
                const headers = ['Equipment,Last Service Date,Last Service HMR,Next Due Hrs,Current HMR,Balance,Status,Notification Sent'];
                const rows = tippers.map(t => [
                    t.equipment,
                    moment(t.lastServiceDate).format('YYYY-MM-DD'),
                    t.lastServiceHmr,
                    t.nextDueHrs,
                    t.currentHmr,
                    t.balance,
                    t.status,
                    t.notificationSent
                ].join(','));
                const csv = [headers, ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('href', url);
                a.setAttribute('download', 'tipper_maintenance.csv');
                a.click();
            };

            const overdueCount = tippers.filter(t => t.status.includes('Overdue')).length;
            const warningCount = tippers.filter(t => t.status.includes('Warning')).length;

            return (
                <div className="container mx-auto p-4">
                    <h1 className="text-3xl font-bold mb-6">Tipper Maintenance Tracker 游댢</h1>
                    
                    <div className="grid grid-cols-3 gap-4 mb-6">
                        <div className="bg-blue-100 p-4 rounded-lg">
                            <h3 className="text-lg font-semibold">Total Tippers</h3>
                            <p className="text-2xl">{tippers.length}</p>
                        </div>
                        <div className="bg-yellow-100 p-4 rounded-lg">
                            <h3 className="text-lg font-semibold">Warnings</h3>
                            <p className="text-2xl">{warningCount}</p>
                        </div>
                        <div className="bg-red-100 p-4 rounded-lg">
                            <h3 className="text-lg font-semibold">Overdue</h3>
                            <p className="text-2xl">{overdueCount}</p>
                        </div>
                    </div>

                    <AddTipperForm addTipper={addTipper} />

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {tippers.map((tipper, index) => (
                            <TipperCard key={index} tipper={tipper} />
                        ))}
                    </div>

                    <div className="mt-6 flex gap-4">
                        <button
                            onClick={exportToCsv}
                            className="bg-green-500 text-white p-2 rounded hover:bg-green-600"
                        >
                            Export to CSV
                        </button>
                        <button
                            onClick={clearData}
                            className="bg-red-500 text-white p-2 rounded hover:bg-red-600"
                        >
                            Clear All Data
                        </button>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
